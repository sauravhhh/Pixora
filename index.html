<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
        }

        .container {
            max-width: 100vw;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 0.5px solid rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            text-align: center;
            letter-spacing: -0.02em;
        }

        .upload-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem 2rem;
            text-align: center;
            margin: 2rem;
            border-radius: 20px;
            background: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .upload-area.hidden {
            display: none;
        }

        .upload-content h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .upload-content p {
            color: #86868b;
            font-size: 1rem;
        }

        .canvas-container {
            flex: 1;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            position: relative;
        }

        .canvas-container.active {
            display: flex;
        }

        .canvas-wrapper {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        canvas {
            display: block;
            max-width: calc(100vw - 2rem);
            max-height: 60vh;
        }

        .crop-overlay {
            position: absolute;
            border: 2px solid #007AFF;
            background: rgba(0, 122, 255, 0.1);
            cursor: move;
            display: none;
            border-radius: 4px;
        }

        .crop-handle {
            position: absolute;
            width: 14px;
            height: 14px;
            background: #007AFF;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .crop-handle.nw { top: -7px; left: -7px; cursor: nw-resize; }
        .crop-handle.ne { top: -7px; right: -7px; cursor: ne-resize; }
        .crop-handle.sw { bottom: -7px; left: -7px; cursor: sw-resize; }
        .crop-handle.se { bottom: -7px; right: -7px; cursor: se-resize; }
        .crop-handle.n { top: -7px; left: 50%; margin-left: -7px; cursor: n-resize; }
        .crop-handle.s { bottom: -7px; left: 50%; margin-left: -7px; cursor: s-resize; }
        .crop-handle.e { right: -7px; top: 50%; margin-top: -7px; cursor: e-resize; }
        .crop-handle.w { left: -7px; top: 50%; margin-top: -7px; cursor: w-resize; }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(0, 0, 0, 0.1);
            padding: 1rem;
            display: none;
            max-height: 50vh;
            overflow-y: auto;
        }

        .controls.active {
            display: block;
        }

        .tab-navigation {
            display: flex;
            margin-bottom: 1.5rem;
            background: #f2f2f7;
            border-radius: 10px;
            padding: 2px;
        }

        .tab-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #86868b;
        }

        .tab-btn.active {
            background: white;
            color: #1d1d1f;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .control-group {
            margin-bottom: 1.5rem;
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label {
            display: block;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: #1d1d1f;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        input[type="range"] {
            flex: 1;
            height: 4px;
            background: #e5e5ea;
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #007AFF;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #007AFF;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        .value-display {
            min-width: 50px;
            text-align: center;
            font-size: 0.9rem;
            color: #86868b;
            font-weight: 500;
        }

        .buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.75rem;
        }

        .tool-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .tool-btn {
            background: white;
            border: 2px solid #e5e5ea;
            padding: 1rem;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .tool-btn:hover {
            border-color: #007AFF;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.15);
        }

        .tool-btn.active {
            border-color: #007AFF;
            background: rgba(0, 122, 255, 0.05);
        }

        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 0.875rem 1rem;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
        }

        button:hover {
            background: #0056CC;
            transform: translateY(-1px);
        }

        button.secondary {
            background: #f2f2f7;
            color: #1d1d1f;
        }

        button.secondary:hover {
            background: #e5e5ea;
        }

        button.danger {
            background: #ff3b30;
        }

        button.danger:hover {
            background: #d70015;
        }

        .file-input {
            display: none;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .filter-option {
            aspect-ratio: 1;
            border: 2px solid #e5e5ea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 500;
            text-align: center;
        }

        .filter-option:hover {
            border-color: #007AFF;
        }

        .filter-option.active {
            border-color: #007AFF;
            background: rgba(0, 122, 255, 0.05);
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            text-align: center;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #e5e5ea;
            border-top: 3px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header {
                padding: 0.75rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .upload-area {
                margin: 1rem;
                padding: 2rem 1rem;
            }

            .tool-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            .buttons {
                grid-template-columns: 1fr;
            }

            canvas {
                max-height: 50vh;
            }

            .controls {
                max-height: 45vh;
            }
        }

        .history-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        input[type="color"] {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .preset-colors {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .preset-color {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #e5e5ea;
            transition: transform 0.2s ease;
        }

        .preset-color:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏ Photo Editor</h1>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-content">
                <h2>üì∑ Choose Photo</h2>
                <p>Tap to select or drag and drop</p>
                <input type="file" id="fileInput" class="file-input" accept="image/*">
            </div>
        </div>

        <div class="canvas-container" id="canvasContainer">
            <div class="canvas-wrapper">
                <canvas id="canvas"></canvas>
                <div class="crop-overlay" id="cropOverlay">
                    <div class="crop-handle nw"></div>
                    <div class="crop-handle ne"></div>
                    <div class="crop-handle sw"></div>
                    <div class="crop-handle se"></div>
                    <div class="crop-handle n"></div>
                    <div class="crop-handle s"></div>
                    <div class="crop-handle e"></div>
                    <div class="crop-handle w"></div>
                </div>
            </div>
        </div>

        <div class="controls" id="controls">
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="switchTab('adjust')">Adjust</button>
                <button class="tab-btn" onclick="switchTab('filters')">Filters</button>
                <button class="tab-btn" onclick="switchTab('tools')">Tools</button>
                <button class="tab-btn" onclick="switchTab('effects')">Effects</button>
            </div>

            <div class="tab-content active" id="adjust">
                <div class="control-group">
                    <label>Exposure</label>
                    <div class="slider-container">
                        <input type="range" id="exposure" min="-100" max="100" value="0">
                        <span class="value-display" id="exposureValue">0</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Brightness</label>
                    <div class="slider-container">
                        <input type="range" id="brightness" min="0" max="200" value="100">
                        <span class="value-display" id="brightnessValue">100</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Highlights</label>
                    <div class="slider-container">
                        <input type="range" id="highlights" min="-100" max="100" value="0">
                        <span class="value-display" id="highlightsValue">0</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Shadows</label>
                    <div class="slider-container">
                        <input type="range" id="shadows" min="-100" max="100" value="0">
                        <span class="value-display" id="shadowsValue">0</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Contrast</label>
                    <div class="slider-container">
                        <input type="range" id="contrast" min="0" max="200" value="100">
                        <span class="value-display" id="contrastValue">100</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Saturation</label>
                    <div class="slider-container">
                        <input type="range" id="saturation" min="0" max="200" value="100">
                        <span class="value-display" id="saturationValue">100</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Vibrance</label>
                    <div class="slider-container">
                        <input type="range" id="vibrance" min="-100" max="100" value="0">
                        <span class="value-display" id="vibranceValue">0</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Warmth</label>
                    <div class="slider-container">
                        <input type="range" id="warmth" min="-100" max="100" value="0">
                        <span class="value-display" id="warmthValue">0</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Tint</label>
                    <div class="slider-container">
                        <input type="range" id="tint" min="-100" max="100" value="0">
                        <span class="value-display" id="tintValue">0</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Sharpness</label>
                    <div class="slider-container">
                        <input type="range" id="sharpness" min="0" max="100" value="0">
                        <span class="value-display" id="sharpnessValue">0</span>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="filters">
                <div class="filter-grid">
                    <div class="filter-option active" onclick="applyFilter('none')">Original</div>
                    <div class="filter-option" onclick="applyFilter('vintage')">Vintage</div>
                    <div class="filter-option" onclick="applyFilter('monochrome')">B&W</div>
                    <div class="filter-option" onclick="applyFilter('sepia')">Sepia</div>
                    <div class="filter-option" onclick="applyFilter('dramatic')">Dramatic</div>
                    <div class="filter-option" onclick="applyFilter('vivid')">Vivid</div>
                    <div class="filter-option" onclick="applyFilter('cool')">Cool</div>
                    <div class="filter-option" onclick="applyFilter('warm')">Warm</div>
                </div>

                <div class="control-group">
                    <label>Filter Intensity</label>
                    <div class="slider-container">
                        <input type="range" id="filterIntensity" min="0" max="100" value="100">
                        <span class="value-display" id="filterIntensityValue">100</span>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tools">
                <div class="tool-buttons">
                    <div class="tool-btn" onclick="toggleCrop()">
                        ‚úÇÔ∏è
                        <span>Crop</span>
                    </div>
                    <div class="tool-btn" onclick="rotateImage()">
                        üîÑ
                        <span>Rotate</span>
                    </div>
                    <div class="tool-btn" onclick="flipHorizontal()">
                        ‚ÜîÔ∏è
                        <span>Flip H</span>
                    </div>
                    <div class="tool-btn" onclick="flipVertical()">
                        ‚ÜïÔ∏è
                        <span>Flip V</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Background Color (for transparency)</label>
                    <div class="color-picker-container">
                        <input type="color" id="bgColor" value="#ffffff">
                        <span>Choose background color</span>
                    </div>
                    <div class="preset-colors">
                        <div class="preset-color" style="background: #ffffff" onclick="setBgColor('#ffffff')"></div>
                        <div class="preset-color" style="background: #000000" onclick="setBgColor('#000000')"></div>
                        <div class="preset-color" style="background: #ff0000" onclick="setBgColor('#ff0000')"></div>
                        <div class="preset-color" style="background: #00ff00" onclick="setBgColor('#00ff00')"></div>
                        <div class="preset-color" style="background: #0000ff" onclick="setBgColor('#0000ff')"></div>
                        <div class="preset-color" style="background: #ffff00" onclick="setBgColor('#ffff00')"></div>
                    </div>
                </div>

                <div class="history-controls">
                    <button onclick="undo()" class="secondary">‚Ü∂ Undo</button>
                    <button onclick="redo()" class="secondary">‚Ü∑ Redo</button>
                </div>
            </div>

            <div class="tab-content" id="effects">
                <div class="control-group">
                    <label>Blur</label>
                    <div class="slider-container">
                        <input type="range" id="blur" min="0" max="20" value="0">
                        <span class="value-display" id="blurValue">0</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Noise</label>
                    <div class="slider-container">
                        <input type="range" id="noise" min="0" max="100" value="0">
                        <span class="value-display" id="noiseValue">0</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Vignette</label>
                    <div class="slider-container">
                        <input type="range" id="vignette" min="0" max="100" value="0">
                        <span class="value-display" id="vignetteValue">0</span>
                    </div>
                </div>

                <button onclick="enhancePhoto()" class="secondary">ü§ñ AI Enhance</button>
            </div>

            <div class="buttons">
                <button onclick="resetImage()" class="secondary">‚Ü©Ô∏è Reset</button>
                <button onclick="downloadImage()">üíæ Save Photo</button>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Processing your photo...</p>
    </div>

    <script>
        let canvas, ctx, originalImage, currentImage;
        let cropMode = false;
        let cropData = { x: 0, y: 0, width: 0, height: 0 };
        let currentFilter = 'none';
        let history = [];
        let historyIndex = -1;
        let isDragging = false;
        let dragHandle = null;
        let dragStart = { x: 0, y: 0 };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            setupEventListeners();
        });

        function setupEventListeners() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');

            // File upload
            fileInput.addEventListener('change', handleFileSelect);
            uploadArea.addEventListener('click', () => fileInput.click());

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.transform = 'translateY(-2px)';
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.transform = 'translateY(0)';
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.transform = 'translateY(0)';
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            // Sliders
            setupSliders();
            
            // Crop functionality
            setupCropHandlers();
        }

        function setupSliders() {
            const sliders = [
                'exposure', 'brightness', 'highlights', 'shadows', 'contrast', 
                'saturation', 'vibrance', 'warmth', 'tint', 'sharpness', 
                'blur', 'noise', 'vignette', 'filterIntensity'
            ];
            
            sliders.forEach(slider => {
                const element = document.getElementById(slider);
                if (element) {
                    const display = document.getElementById(slider + 'Value');
                    
                    element.addEventListener('input', function() {
                        display.textContent = this.value;
                        applyAllEffects();
                    });
                }
            });
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            showLoading();
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    loadImage(img);
                    hideLoading();
                };
                img.onerror = function() {
                    hideLoading();
                    alert('Error loading image');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function loadImage(img) {
            originalImage = img;
            currentImage = img;

            // Calculate canvas size
            const maxWidth = Math.min(window.innerWidth - 40, 800);
            const maxHeight = window.innerHeight * 0.6;
            
            let { width, height } = calculateDimensions(img.width, img.height, maxWidth, maxHeight);
            
            canvas.width = width;
            canvas.height = height;

            // Reset history
            history = [];
            historyIndex = -1;
            saveToHistory();

            drawImage();

            // Show editor
            document.getElementById('uploadArea').classList.add('hidden');
            document.getElementById('canvasContainer').classList.add('active');
            document.getElementById('controls').classList.add('active');

            // Reset all controls
            resetControls();
        }

        function calculateDimensions(imgWidth, imgHeight, maxWidth, maxHeight) {
            let width = imgWidth;
            let height = imgHeight;

            if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
            }

            if (height > maxHeight) {
                width = (width * maxHeight) / height;
                height = maxHeight;
            }

            return { width: Math.round(width), height: Math.round(height) };
        }

        function drawImage() {
            if (!currentImage) return;
            
            const bgColor = document.getElementById('bgColor').value;
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
        }

        function applyAllEffects() {
            if (!originalImage) return;

            // Get all slider values
            const exposure = parseFloat(document.getElementById('exposure').value);
            const brightness = parseFloat(document.getElementById('brightness').value);
            const highlights = parseFloat(document.getElementById('highlights').value);
            const shadows = parseFloat(document.getElementById('shadows').value);
            const contrast = parseFloat(document.getElementById('contrast').value);
            const saturation = parseFloat(document.getElementById('saturation').value);
            const vibrance = parseFloat(document.getElementById('vibrance').value);
            const warmth = parseFloat(document.getElementById('warmth').value);
            const tint = parseFloat(document.getElementById('tint').value);
            const blur = parseFloat(document.getElementById('blur').value);
            const filterIntensity = parseFloat(document.getElementById('filterIntensity').value);

            // Create filter string
            let filters = [];
            
            // Basic adjustments
            if (brightness !== 100) filters.push(`brightness(${brightness}%)`);
            if (contrast !== 100) filters.push(`contrast(${contrast}%)`);
            if (saturation !== 100) filters.push(`saturate(${saturation}%)`);
            
            // Advanced adjustments (approximated with CSS filters)
            if (exposure !== 0) {
                const exposureValue = 100 + exposure;
                filters.push(`brightness(${exposureValue}%)`);
            }
            
            if (warmth !== 0) {
                const hue = warmth * 0.3; // Convert to hue rotation
                filters.push(`hue-rotate(${hue}deg)`);
            }
            
            if (blur > 0) filters.push(`blur(${blur}px)`);

            // Apply current filter
            const filterEffects = getFilterEffects(currentFilter, filterIntensity);
            filters = filters.concat(filterEffects);

            ctx.filter = filters.join(' ') || 'none';
            drawImage();
            
            // Apply post-processing effects
            applyPostEffects();
            
            ctx.filter = 'none';
        }

        function applyPostEffects() {
            const noise = parseFloat(document.getElementById('noise').value);
            const vignette = parseFloat(document.getElementById('vignette').value);
            
            if (noise > 0) {
                applyNoise(noise);
            }
            
            if (vignette > 0) {
                applyVignette(vignette);
            }
        }

        function applyNoise(intensity) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const noise = (Math.random() - 0.5) * intensity * 2;
                data[i] = Math.max(0, Math.min(255, data[i] + noise));     // Red
                data[i + 1] = Math.max(0, Math.min(255, data[i + 1] + noise)); // Green
                data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + noise)); // Blue
            }
            
            ctx.putImageData(imageData, 0, 0);
        }

        function applyVignette(intensity) {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.sqrt(centerX * centerX + centerY * centerY);
            
            const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
            gradient.addColorStop(0, `rgba(0, 0, 0, 0)`);
            gradient.addColorStop(1, `rgba(0, 0, 0, ${intensity / 100})`);
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function getFilterEffects(filterName, intensity) {
            const i = intensity / 100;
            
            switch (filterName) {
                case 'vintage':
                    return [`sepia(${30 * i}%)`, `contrast(${100 + 20 * i}%)`, `saturate(${80 + 20 * i}%)`];
                case 'monochrome':
                    return [`grayscale(${100 * i}%)`];
                case 'sepia':
                    return [`sepia(${100 * i}%)`];
                case 'dramatic':
                    return [`contrast(${100 + 50 * i}%)`, `saturate(${100 + 30 * i}%)`, `brightness(${90 + 10 * i}%)`];
                case 'vivid':
                    return [`saturate(${100 + 50 * i}%)`, `contrast(${100 + 20 * i}%)`];
                case 'cool':
                    return [`hue-rotate(${-20 * i}deg)`, `saturate(${100 + 10 * i}%)`];
                case 'warm':
                    return [`hue-rotate(${20 * i}deg)`, `saturate(${100 + 20 * i}%)`];
                default:
                    return [];
            }
        }

        function applyFilter(filterName) {
            // Update active filter button
            document.querySelectorAll('.filter-option').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            currentFilter = filterName;
            applyAllEffects();
        }

        function rotateImage() {
            if (!currentImage) return;
            
            showLoading();
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // Swap width and height for rotation
            tempCanvas.width = canvas.height;
            tempCanvas.height = canvas.width;
            
            // Rotate 90 degrees clockwise
            tempCtx.translate(tempCanvas.width / 2, tempCanvas.height / 2);
            tempCtx.rotate(Math.PI / 2);
            tempCtx.drawImage(canvas, -canvas.width / 2, -canvas.height / 2);
            
            const newImg = new Image();
            newImg.onload = function() {
                currentImage = newImg;
                canvas.width = tempCanvas.width;
                canvas.height = tempCanvas.height;
                saveToHistory();
                applyAllEffects();
                hideLoading();
            };
            newImg.src = tempCanvas.toDataURL();
        }

        function flipHorizontal() {
            if (!currentImage) return;
            flip(-1, 1);
        }

        function flipVertical() {
            if (!currentImage) return;
            flip(1, -1);
        }

        function flip(scaleX, scaleY) {
            showLoading();
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            
            tempCtx.save();
            tempCtx.scale(scaleX, scaleY);
            tempCtx.drawImage(canvas, 
                scaleX < 0 ? -tempCanvas.width : 0, 
                scaleY < 0 ? -tempCanvas.height : 0
            );
            tempCtx.restore();
            
            const newImg = new Image();
            newImg.onload = function() {
                currentImage = newImg;
                saveToHistory();
                applyAllEffects();
                hideLoading();
            };
            newImg.src = tempCanvas.toDataURL();
        }

        function toggleCrop() {
            cropMode = !cropMode;
            const cropOverlay = document.getElementById('cropOverlay');
            
            if (cropMode) {
                showCropOverlay();
            } else {
                applyCrop();
                hideCropOverlay();
            }
        }

        function showCropOverlay() {
            const rect = canvas.getBoundingClientRect();
            const overlay = document.getElementById('cropOverlay');
            
            const cropWidth = Math.min(canvas.width * 0.8, canvas.width - 40);
            const cropHeight = Math.min(canvas.height * 0.8, canvas.height - 40);
            const cropX = (canvas.width - cropWidth) / 2;
            const cropY = (canvas.height - cropHeight) / 2;
            
            overlay.style.left = (rect.left + cropX) + 'px';
            overlay.style.top = (rect.top + cropY) + 'px';
            overlay.style.width = cropWidth + 'px';
            overlay.style.height = cropHeight + 'px';
            overlay.style.display = 'block';
            
            cropData = {
                x: cropX,
                y: cropY,
                width: cropWidth,
                height: cropHeight
            };
        }

        function hideCropOverlay() {
            document.getElementById('cropOverlay').style.display = 'none';
        }

        function setupCropHandlers() {
            const overlay = document.getElementById('cropOverlay');
            const handles = overlay.querySelectorAll('.crop-handle');
            
            // Handle dragging
            overlay.addEventListener('mousedown', startCropDrag);
            overlay.addEventListener('touchstart', startCropDrag);
            
            handles.forEach(handle => {
                handle.addEventListener('mousedown', startHandleDrag);
                handle.addEventListener('touchstart', startHandleDrag);
            });
            
            document.addEventListener('mousemove', cropDrag);
            document.addEventListener('touchmove', cropDrag);
            document.addEventListener('mouseup', stopCropDrag);
            document.addEventListener('touchend', stopCropDrag);
        }

        function startCropDrag(e) {
            if (e.target.classList.contains('crop-handle')) return;
            
            isDragging = true;
            dragHandle = 'move';
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            
            dragStart = {
                x: clientX - parseFloat(document.getElementById('cropOverlay').style.left),
                y: clientY - parseFloat(document.getElementById('cropOverlay').style.top)
            };
            
            e.preventDefault();
        }

        function startHandleDrag(e) {
            isDragging = true;
            dragHandle = e.target.className.split(' ')[1];
            
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            
            dragStart = { x: clientX, y: clientY };
            e.preventDefault();
            e.stopPropagation();
        }

        function cropDrag(e) {
            if (!isDragging || !cropMode) return;
            
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            const overlay = document.getElementById('cropOverlay');
            const canvasRect = canvas.getBoundingClientRect();
            
            if (dragHandle === 'move') {
                const newX = clientX - dragStart.x;
                const newY = clientY - dragStart.y;
                
                // Constrain to canvas bounds
                const maxX = canvasRect.width - cropData.width;
                const maxY = canvasRect.height - cropData.height;
                
                const constrainedX = Math.max(canvasRect.left, Math.min(newX, canvasRect.left + maxX));
                const constrainedY = Math.max(canvasRect.top, Math.min(newY, canvasRect.top + maxY));
                
                overlay.style.left = constrainedX + 'px';
                overlay.style.top = constrainedY + 'px';
                
                cropData.x = constrainedX - canvasRect.left;
                cropData.y = constrainedY - canvasRect.top;
            } else {
                // Handle resize
                const deltaX = clientX - dragStart.x;
                const deltaY = clientY - dragStart.y;
                
                let newX = cropData.x;
                let newY = cropData.y;
                let newWidth = cropData.width;
                let newHeight = cropData.height;
                
                switch (dragHandle) {
                    case 'nw':
                        newX += deltaX;
                        newY += deltaY;
                        newWidth -= deltaX;
                        newHeight -= deltaY;
                        break;
                    case 'ne':
                        newY += deltaY;
                        newWidth += deltaX;
                        newHeight -= deltaY;
                        break;
                    case 'sw':
                        newX += deltaX;
                        newWidth -= deltaX;
                        newHeight += deltaY;
                        break;
                    case 'se':
                        newWidth += deltaX;
                        newHeight += deltaY;
                        break;
                    case 'n':
                        newY += deltaY;
                        newHeight -= deltaY;
                        break;
                    case 's':
                        newHeight += deltaY;
                        break;
                    case 'e':
                        newWidth += deltaX;
                        break;
                    case 'w':
                        newX += deltaX;
                        newWidth -= deltaX;
                        break;
                }
                
                // Constrain dimensions
                if (newWidth >= 50 && newHeight >= 50 && 
                    newX >= 0 && newY >= 0 && 
                    newX + newWidth <= canvas.width && 
                    newY + newHeight <= canvas.height) {
                    
                    cropData = { x: newX, y: newY, width: newWidth, height: newHeight };
                    
                    overlay.style.left = (canvasRect.left + newX) + 'px';
                    overlay.style.top = (canvasRect.top + newY) + 'px';
                    overlay.style.width = newWidth + 'px';
                    overlay.style.height = newHeight + 'px';
                }
                
                dragStart = { x: clientX, y: clientY };
            }
            
            e.preventDefault();
        }

        function stopCropDrag() {
            isDragging = false;
            dragHandle = null;
        }

        function applyCrop() {
            if (!cropMode || !currentImage) return;
            
            showLoading();
            
            const scaleX = currentImage.width / canvas.width;
            const scaleY = currentImage.height / canvas.height;
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCanvas.width = cropData.width;
            tempCanvas.height = cropData.height;
            
            // Draw cropped portion
            tempCtx.drawImage(canvas,
                cropData.x, cropData.y, cropData.width, cropData.height,
                0, 0, cropData.width, cropData.height
            );
            
            const newImg = new Image();
            newImg.onload = function() {
                currentImage = newImg;
                canvas.width = cropData.width;
                canvas.height = cropData.height;
                saveToHistory();
                applyAllEffects();
                hideLoading();
            };
            newImg.src = tempCanvas.toDataURL();
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
        }

        function setBgColor(color) {
            document.getElementById('bgColor').value = color;
            applyAllEffects();
        }

        function saveToHistory() {
            if (!canvas) return;
            
            // Remove future history if we're not at the end
            history = history.slice(0, historyIndex + 1);
            
            // Add current state
            history.push(canvas.toDataURL());
            historyIndex++;
            
            // Limit history size
            if (history.length > 20) {
                history.shift();
                historyIndex--;
            }
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                restoreFromHistory();
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                restoreFromHistory();
            }
        }

        function restoreFromHistory() {
            const img = new Image();
            img.onload = function() {
                currentImage = img;
                drawImage();
            };
            img.src = history[historyIndex];
        }

        function resetImage() {
            if (!originalImage) return;
            
            currentImage = originalImage;
            const maxWidth = Math.min(window.innerWidth - 40, 800);
            const maxHeight = window.innerHeight * 0.6;
            
            let { width, height } = calculateDimensions(
                originalImage.width, 
                originalImage.height, 
                maxWidth, 
                maxHeight
            );
            
            canvas.width = width;
            canvas.height = height;
            
            resetControls();
            saveToHistory();
            applyAllEffects();
        }

        function resetControls() {
            const controls = {
                'exposure': 0, 'brightness': 100, 'highlights': 0, 'shadows': 0,
                'contrast': 100, 'saturation': 100, 'vibrance': 0, 'warmth': 0,
                'tint': 0, 'sharpness': 0, 'blur': 0, 'noise': 0, 'vignette': 0,
                'filterIntensity': 100
            };
            
            Object.entries(controls).forEach(([id, value]) => {
                const element = document.getElementById(id);
                const display = document.getElementById(id + 'Value');
                if (element && display) {
                    element.value = value;
                    display.textContent = value;
                }
            });
            
            // Reset filter
            currentFilter = 'none';
            document.querySelectorAll('.filter-option').forEach((btn, index) => {
                btn.classList.toggle('active', index === 0);
            });
            
            // Reset background color
            document.getElementById('bgColor').value = '#ffffff';
        }

        async function enhancePhoto() {
            if (!canvas) return;
            
            showLoading();
            
            try {
                // Convert canvas to blob
                const blob = await new Promise(resolve => canvas.toBlob(resolve));
                
                // Create form data for API
                const formData = new FormData();
                formData.append('image', blob, 'photo.png');
                formData.append('enhance_type', 'auto');
                
                // Note: This is a placeholder for AI enhancement
                // In a real implementation, you would call an actual AI service
                setTimeout(() => {
                    // Simulate AI enhancement by applying some automatic adjustments
                    document.getElementById('contrast').value = 110;
                    document.getElementById('contrastValue').textContent = '110';
                    document.getElementById('saturation').value = 105;
                    document.getElementById('saturationValue').textContent = '105';
                    document.getElementById('sharpness').value = 15;
                    document.getElementById('sharpnessValue').textContent = '15';
                    
                    saveToHistory();
                    applyAllEffects();
                    hideLoading();
                    
                    alert('‚ú® Photo enhanced with AI adjustments!');
                }, 2000);
                
            } catch (error) {
                hideLoading();
                alert('Enhancement failed. Please try again.');
            }
        }

        function downloadImage() {
            if (!canvas) return;
            
            // Get current timestamp for filename
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            
            const link = document.createElement('a');
            link.download = `photo-edit-${timestamp}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            if (currentImage && !cropMode) {
                const maxWidth = Math.min(window.innerWidth - 40, 800);
                const maxHeight = window.innerHeight * 0.6;
                
                let { width, height } = calculateDimensions(
                    currentImage.width, 
                    currentImage.height, 
                    maxWidth, 
                    maxHeight
                );
                
                canvas.width = width;
                canvas.height = height;
                applyAllEffects();
            }
        });

        // Prevent context menu on long press (mobile)
        document.addEventListener('contextmenu', function(e) {
            if (e.target.tagName === 'CANVAS' || e.target.closest('.crop-overlay')) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>